# PWA通知機能の使い方

変動費の入力忘れを通知で知らせる機能を実装しました。

## 実装内容

### 1. 固定費のバリデーション ✅
- 固定費設定で金額が0円または空欄の場合、保存時にエラー表示
- 変動費（金額フィールド無効）のみ `null` で登録可能

### 2. PWA通知機能 ✅

#### 自動通知
- **チェック間隔**: 1時間ごと
- **通知条件**: 金額が未入力（null または 0）のレコードが存在する場合
- **通知内容**: 「変動費の入力が必要です」+ 未入力件数

#### 通知の流れ
1. アプリ初回起動時に通知許可をリクエスト
2. ユーザーが許可した場合、バックグラウンドで定期チェック開始
3. 未入力の変動費があれば通知を表示
4. 通知をタップするとアプリを開く

## ユーザー操作

### 通知を有効にする
1. アプリを初めて開くと「変動費の入力忘れを通知で知らせますか?」と表示される
2. 「OK」をタップすると通知が有効になる

### 通知を後から有効にする
ブラウザの設定 → サイトの設定 → 通知 → 許可

### 通知を無効にする
ブラウザの設定 → サイトの設定 → 通知 → ブロック

## フロー例

### 変動費の登録から通知まで

1. **固定費設定画面**
   - 「変動費を追加」ボタンをタップ
   - 支払日とカテゴリを設定（金額は「金額は都度入力」と表示され入力不可）
   - 保存

2. **Edge Function（毎日自動実行）**
   - 設定した日付になると `expenses` テーブルに `amount = null` で挿入

3. **管理タブ（支出明細）**
   - 該当セルが**赤色**でハイライト
   - 表示: `⚠️未入力`
   - ツールチップ: 「⚠️ 金額を入力してください」

4. **PWA通知（1時間ごと自動チェック）**
   - 未入力のレコードがある場合、通知を表示
   - 「今すぐ入力」タップでアプリを開く

5. **金額入力**
   - セルをタップして金額を入力
   - 赤色ハイライトが解除される

## 技術詳細

### 実装したファイル

- **`src/utils/notificationService.ts`**: 通知のコア機能
- **`src/hooks/useNotificationSetup.ts`**: 通知許可リクエスト
- **`src/hooks/useVariableCostNotification.ts`**: 定期チェック機能
- **`vite.config.ts`**: Workbox設定（Service Worker）

### 通知の仕組み

1. **Service Worker**: PWA のバックグラウンド処理を担当
2. **Notification API**: ブラウザのネイティブ通知機能
3. **定期チェック**: `setInterval` で1時間ごとに Supabase からデータ取得
4. **通知表示**: 未入力件数をカウントして通知

## 注意事項

- **iOS Safari**: プッシュ通知はサポートされていますが、動作が制限される場合があります
- **バッテリー**: 定期チェックはバッテリー消費を考慮して1時間間隔に設定
- **プライバシー**: 通知はローカルで生成され、外部サーバーにデータは送信されません

## カスタマイズ

### チェック間隔を変更

`src/hooks/useVariableCostNotification.ts` の以下の部分を変更:

```typescript
60 * 60 * 1000,  // 1時間ごと
↓
30 * 60 * 1000,  // 30分ごと
```

### 通知メッセージを変更

`src/utils/notificationService.ts` の `notifyPendingVariableCosts` 関数:

```typescript
await showNotification('変動費の入力が必要です', {
  body: `${count}件の変動費で金額が未入力です。\nタップして入力してください。`,
  // ...
});
```
